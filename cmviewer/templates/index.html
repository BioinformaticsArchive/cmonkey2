<!doctype html>
<html>
  <head>
    <title>cMonkey2 Viewer</title>
    <link rel="stylesheet" media="screen" href="/static/stylesheets/main.css">
    <link rel="stylesheet" media="screen" href="/static/stylesheets/jquery.dataTables.css">
    <link rel="stylesheet" media="screen" href="/static/javascripts/jquery-ui-1.11.2.custom/jquery-ui.min.css">
    <link rel="shortcut icon" type="image/png" href="/static/images/favicon.png">
    <script src="/static/javascripts/jquery-2.1.1.min.js" type="text/javascript"></script>
    <script src="/static/javascripts/jquery.dataTables.min.js" type="text/javascript"></script>
    <script src="/static/javascripts/jquery-ui-1.11.2.custom/jquery-ui.min.js" type="text/javascript"></script>
    <script src="/static/javascripts/highcharts.js" type="text/javascript"></script>
    <script src="/static/javascripts/highcharts-more.js" type="text/javascript"></script>
    <script src="/static/javascripts/modules/exporting.js" type="text/javascript"></script>
    <script src="/static/javascripts/isblogo.js" type="text/javascript"></script>
    <script src="/static/javascripts/raphael-min.js"></script>
    <script src="/static/javascripts/gene_annotations.js" type="text/javascript"></script>
    <script src="/static/javascripts/cytoscape.min.js" type="text/javascript"></script>
    <script src="/static/javascripts/springy.js" type="text/javascript"></script>

    <style media="all" type="text/css">
      .alignRight { text-align: right; }

      #cy {
        font-family: helvetica neue, helvetica, arial, sans-serif;
        height: 400px;
        width: 90%;
        position: absolute;
        left: 10;
        top: 100;
      }
      #network-tab { height: 500px}
    </style>

    <script type="text/javascript">
      var INITIAL_NETWORK_FILTER_SCALE = 8;
      var currentIteration = 1;

      function assignClusterClickHandlers() {
        var cluster = $(this).attr('id');
        $.get('/cluster/' + currentIteration + '/' + cluster,
              function(html) {
                // we need the trim() call in order for jQuery 1.9.x to
                // recognize the output as valid HTML
                $(html.trim()).replaceAll('#cluster-view');
                // notify Firegoose to rescan the page
                var ev = document.createEvent("Events");
                ev.initEvent("gaggleDataEvent", true, false);
                document.dispatchEvent(ev);
              });
        return false;
      }

      function clearClusterDetailView() {
        $("<span id=\"cluster-view\">Please select a cluster</span>").replaceAll('#cluster-view');
      }

      function showClusterDetails(cluster) {
        $.get('/cluster/' + currentIteration + '/' + cluster,
              function(html) {
                $(html.trim()).replaceAll('#cluster-view');
                $("#tabs").tabs( "option", "active", 1);
                // notify Firegoose to rescan the page
                var ev = document.createEvent("Events");
                ev.initEvent("gaggleDataEvent", true, false);
                document.dispatchEvent(ev);
              });
      }

      function initCytoweb(iteration, minResidual, maxResidual, minEvalue, maxEvalue) {
        var cy = $('#cy').cytoscape({
          style: cytoscape.stylesheet()
            .selector('node').css({
              'content': 'data(name)',
              'text-valign': 'center',
              'color': 'black',
              'min-zoomed-font-size': 7
            })
            .selector('edge').css({
              'target-arrow-shape': 'none',
              'curve-style': 'haystack'
            })
            .selector('.clusters').css({
              'color': 'green', 'background-color': 'red',
              'width': 10, 'height': 10, 'font-size': '8'
            })
            .selector('.genes').css({
              'width': 5, 'height': 5, 'font-size': '3'
            })
            .selector('.motifs').css({
              'width': 5, 'height': 5, 'font-size': '3', 'shape': 'triangle',
              'background-color': 'green'
            })
            .selector(':selected').css({
              'background-color': 'black',
              'line-color': 'black',
            })
            .selector('.faded').css({
              'opacity': 0.25,
              'text-opacity': 0
            }),
          ready: function() {
            var cy = this;
                cy.startBatch();
                jQuery.getJSON('/cytoscape_nodes/' + iteration,
                               {
                                 min_residual: minResidual,
                                 max_residual: maxResidual,
                                 min_evalue: minEvalue,
                                 max_evalue: maxEvalue,
                               },
                               function(nodes) {
                                 cy.add(nodes);
                                 jQuery.getJSON('/cytoscape_edges/' + iteration,
                                                {
                                                  min_residual: minResidual,
                                                  max_residual: maxResidual,
                                                  min_evalue: minEvalue,
                                                  max_evalue: maxEvalue,
                                                },
                                                function(edges) {
                                   cy.add(edges);
                                   cy.endBatch();
                                   cy.layout({name: 'springy', animate: false, fit: true});
                                   cy.fit();
                                   cy.on('tap', 'node', function() {
                                     // open tab 1 with a filled in detail view
                                     if (this.hasClass('clusters')) {
                                       showClusterDetails(this.id());
                                     }
                                   });
                                 });
                               });

          },
          pixelRatio: 1.0,
          motionBlur: true,
          hideEdgesOnViewport: true,
          hideLabelsOnViewport: true,
          textureOnViewport: true
        });
      }

      $(document).ready(function() {
         $('#progressbar').progressbar({value: {{progress}}});
         $('.progress-label').text("{{progress}}%");
         $('#tabs').tabs({
            activate: function(event, ui) {
              var active = $('#tabs').tabs("option", "active");
              if (active == 2) {
                var residuals = $('#residual-slider').slider("values");
                var evalues = $('#evalue-slider').slider("values");
                initCytoweb(currentIteration, residuals[0], residuals[1],
                            evalues[0], evalues[1]);

              } else if (active == 1) {
                $('#cluster-list').dataTable().fnAdjustColumnSizing();
              }
            }
         });
         $('#select_iteration').change(function (event) {
             currentIteration = $(this).val();
             var iteration = $(this).val();
             // Update cluster list and networks
             var activeTab = $('#tabs').tabs("option", "active");

             $('#cluster-list').DataTable().ajax.url('/clusters/' + iteration).load();
             clearClusterDetailView();

             if (activeTab == 2) { // only update this if we are in the network tab
               var residuals = $('#residual-slider').slider("values");
               var evalues = $('#evalue-slider').slider("values");
               initCytoweb(iteration, residuals[0], residuals[1], evalues[0], evalues[1]);
             }
         });
         var iterations = {{js_iterations}};

         // residual graph
         var titleSize = '11pt';
         $('#residual-graph').highcharts({
             chart: {
                 type: 'line',
                 width: 300, height: 200
             },
             title: { text: 'Mean Residual', style: {'fontSize': titleSize} },
             plotOptions: { line: { marker: { enabled: false }, } },
             xAxis: {
                 categories: iterations,
                 tickInterval: 30
             },
             yAxis: { title: { text: 'mean resids' } },
             series: [{name: 'mean resid', data: {{js_mean_residuals}} }]
         });

         // cluster member graph
         $('#cluster-member-graph').highcharts({
             chart: {
                 type: 'line',
                 width: 300, height: 200
             },
             title: { text: 'Mean nrow, ncol/iter', style: {'fontSize': titleSize} },
             plotOptions: { line: { marker: { enabled: false }, } },
             xAxis: {
                 categories: iterations,
                 tickInterval: 30
             },
             yAxis: { title: { text: 'mean nrow, ncol/iter' } },
             series: [{name: 'columns', data: {{js_mean_ncol}} },
                      {name: 'rows', data: {{js_mean_nrow}} }]
         });
         // cluster nrows graph
         $('#cluster-row-graph').highcharts({
             chart: {
                 type: 'column',
                 width: 300, height: 200
             },
             title: { text: '# clusters -> # rows', style: {'fontSize': titleSize} },
             xAxis: {
                 categories: {{js_nrows_x}},
                 tickInterval: 5
             },
             yAxis: { title: { text: '# clusters' } },
             series: [ { name: '# rows', data: {{js_nrows_y}} } ]
         });

         // cluster ncols graph
         $('#cluster-column-graph').highcharts({
             chart: {
                 type: 'column',
                 width: 300, height: 200
             },
             title: { text: '# clusters -> # columns', style: {'fontSize': titleSize} },
             xAxis: {
                 categories: {{js_ncols_x}},
                 tickInterval: 2
             },
             yAxis: { title: { text: '# clusters' } },
             series: [ { name: '# columns', data: {{js_ncols_y}} } ]
         });

         // cluster residual graph
         $('#cluster-residual-graph').highcharts({
             chart: {
                 type: 'column',
                 width: 300, height: 200
             },
             title: { text: 'cluster residuals', style: {'fontSize': titleSize} },
             xAxis: {
                 categories: {{js_resids_x}},
                 tickInterval: 3
             },
             yAxis: { title: { text: '# clusters' } },
             series: [ { name: 'residual', data: {{js_resids_y}} } ]
         });

         $('#runlog-graph').highcharts({
             chart: {type: 'line', width: 300, height: 200},
             title: {text: 'Run parameters', style: {'fontSize': titleSize}},
             plotOptions: { line: { marker: { enabled: false }, } },
             yAxis: { title: { text: 'scaling' }, min: 0 },
             series: {{js_runlog_series}}
         });

         $('#motif-score-graph').highcharts({
             chart: {type: 'line', width: 300, height: 200},
             title: { text: 'Median scores', style: {'fontSize': titleSize} },
             plotOptions: { line: { marker: { enabled: false }, } },
             xAxis: {categories: iterations, tickInterval: 30},
             yAxis: { title: { text: 'mean p-value' }, max: {{max_stats_score}}, min: {{min_stats_score}} },
             series: {{js_stats}}
         });

         $('#network-score-graph').highcharts({
             chart: {
                 type: 'line',
                 width: 300, height: 200
             },
             title: { text: 'Mean network scores', style: {'fontSize': titleSize} },
             plotOptions: { line: { marker: { enabled: false }, } },
             xAxis: {
                 categories: iterations,
                 tickInterval: 30
             },
             yAxis: { title: { text: 'mean net score' }, max: {{max_netscore}}, min: {{min_netscore}} },
             series: {{js_network_stats}}
         });

         $('#fuzzy-graph').highcharts({
             chart: {
                 type: 'line',
                 width: 300, height: 200
             },
             title: { text: 'Fuzzy coefficient', style: {'fontSize': titleSize} },
             plotOptions: { line: { marker: { enabled: false }, } },
             xAxis: {
                 categories: iterations,
                 tickInterval: 30
             },
             yAxis: { title: { text: 'fuzzy coeff' } },
             series: [{name: 'fuzzy coeff', data: {{js_fuzzy_coeff}}}]
         });

         $('#cluster-list').dataTable({
           'bPaginate': false,
           'bFilter': false,
           'bSort': true,
           'bInfo': false,
           'bServerSide': true,
           'sScrollY': 300,
           'sScrollX': '100%',
           'bProcessing': true,
           'aoColumns': [
             { 'sWidth': '30px', 'sClass': 'alignRight', 'bSortable': false },
             { 'sWidth': '60px', 'sClass': 'alignRight' },
             { 'sWidth': '60px', 'sClass': 'alignRight' },
             { 'sWidth': '60px', 'sClass': 'alignRight' },
             { 'sWidth': '70px', 'sClass': 'alignRight' },
             { 'bSortable': true }
           ],
           
           'sAjaxSource': '/clusters/' + currentIteration,
         }).on('order.dt', function() {
            $('a.clusterlink').click(assignClusterClickHandlers);
         });
        
        // sliders
        $('#residual-slider').slider({
          range: true,
          min: {{min_residual}},
          max: {{max_residual}},
          step: {{residual_step}},
          values: [{{min_residual}}, {{max_residual}} / INITIAL_NETWORK_FILTER_SCALE],
          slide: function(event, ui) {
            var values = $('#residual-slider').slider("values");
            $('#residual-range').html('[' + values[0] + '-' + values[1] + ']');
          },
          stop: function(event, ui) {
            var residuals = $('#residual-slider').slider("values");
            var evalues = $('#evalue-slider').slider("values");
            initCytoweb(currentIteration, residuals[0], residuals[1], evalues[0], evalues[1]);
          }
        });
        $('#evalue-slider').slider({
          range: true,
          min: {{min_evalue}},
          max: {{max_evalue}},
          step: {{evalue_step}},
          values: [{{min_evalue}}, {{max_evalue}} / INITIAL_NETWORK_FILTER_SCALE],
          slide: function(event, ui) {
            var values = $('#evalue-slider').slider("values");
            $('#evalue-range').html('[' + values[0] + '-' + values[1] + ']');
          },
          stop: function(event, ui) {
            var residuals = $('#residual-slider').slider("values");
            var evalues = $('#evalue-slider').slider("values");
            initCytoweb(currentIteration, residuals[0], residuals[1], evalues[0], evalues[1]);
          }
        });
      });
    </script>
  </head>
  <body>
   <div id="maincontainer">
     <div id="topsection">
       <div><img style="float: right" alt="Institute for Systems Biology" src="/static/images/isb_logo.png"></div>
       <a href="/"><img src="/static/images/cmonkey2_logo.png" style="width:80px" title="cMonkey 2 Viewer"></a>
       <div progress-section>
         <div id="progressbar"><div class="progress-label">Running...</div></div>
         <div id="progress-info">
           <div class="start-info">Run started at {{runinfo.start_time}}</div>
           {% if not runinfo.finish_time %}
           <div class="inprogress-info">Run in progress...</div>
           {% else %}
           <div class="finish-info">Run finished at {{runinfo.finish_time}} {{elapsed_time}}</div>
           {% endif %}
         </div>
       </div>
       <div style="height: 10px;">&nbsp;</div>
       <div style="height: 10px;">&nbsp;</div>

       <div class="run-info">
         {{runinfo.species}} ({{runinfo.orgcode}})<br>{{runinfo.num_rows}} genes, {{runinfo.num_cols}} conditions, {{runinfo.num_clusters}} clusters
       </div>
       <div>&nbsp;</div>

       <!-- Dynamically replaced -->
       <div>Iteration <select id="select_iteration">
       {% for iter in iterations %}{% if iter == current_iter %}
         <option value="{{iter}}" selected>{{iter}}</option>
       {% else %}<option value="{{iter}}">{{iter}}</option>{% endif %}{% endfor %}
       </select>/{{runinfo.num_iters}}
       </div>
       <div style="height: 10px;">&nbsp;</div>

     </div>

     <div id="tabs">
       <ul>
         <li><a href="#stats-tab">Statistics</a></li>
         <li><a href="#cluster-tab">Clusters</a></li>
         <li><a href="#network-tab">Network</a></li>
       </ul>

       <div id="stats-tab">
         <div id="statssection">
           <div id="leftcolumn">
             <div class="innertube">
               <div id="cluster-row-graph"></div><div id="cluster-column-graph"></div><div id="motif-score-graph"></div>
             </div>
           </div>
           <div id="rightcolumn">
             <div class="innertube">
               <div id="residual-graph"></div><div id="cluster-member-graph"></div><div id="network-score-graph"></div>
             </div>
           </div>
           <div id="contentcolumn">
             <div class="innertube">
               <div id="cluster-residual-graph"></div><div id="runlog-graph"></div><div id="fuzzy-graph"></div>
             </div>
           </div>
         </div>
         <div style="clear: both"></div>
       </div>

       <div id="cluster-tab">
         <div id="clustersection">
           <table class="item-list" id="cluster-list">
             <thead>
               <tr><th>#</th><th>Cluster</th><th># rows</th><th># columns</th><th>residual</th><th>motif/e-value</th></tr>
             </thead>
             <tbody>
             </tbody>
           </table>
           <div class="spacer">&nbsp;</div>
           <div class="details-box">
             <span id="cluster-view">Please select a cluster</span>
           </div>
         </div>
       </div>

       <div id="network-tab">
         <div id="slider-section">
           <div id="left-slider-column">
             <div>Cluster residual</div>
             <div style="font-size: 9pt" id="residual-range">[{{min_residual}}-{{max_residual}}]</div>
             <div id="residual-slider"></div>
           </div>
           <div id="right-slider-column">
             <div>Motif e-value</div>
             <div style="font-size: 9pt" id="evalue-range">[{{min_evalue}}-{{max_evalue}}]</div>
             <div id="evalue-slider"></div>
           </div>
         </div>

         <div id="cy"></div>
       </div> <!-- network tab -->

     </div>
   </div>

  </body>
</html>
